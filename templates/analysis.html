{% extends "layout.html" %}

{% block title %}
An√°lisis Mensual
{% endblock %}

{% block main %}
<div class="container mt-4">
  <h2 class="text-center mb-4">üìä An√°lisis Mensual</h2>

  <div class="row text-center mb-5">
    <div class="col-md-6">
      <div class="card card-custom border-success mb-3">
        <div class="card-body">
          <h5 class="card-title">üí∞ Total Ingresos</h5>
          <p class="h3 text-success mb-1">${{ "%.2f"|format(income_total|float) }}</p>
          <p class="text-muted">{{ income_pct }}% del total</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card card-custom border-danger mb-3">
        <div class="card-body">
          <h5 class="card-title">üí∏ Total Gastos</h5>
          <p class="h3 text-danger mb-1">${{ "%.2f"|format(expense_total|float) }}</p>
          <p class="text-muted">{{ expense_pct }}% del total</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card card-custom mb-4">
    <div class="card-body">
      <h5 class="text-center mb-4">Gastos por Categor√≠a</h5>
      {% if category_percentages %}
      <ul class="list-group">
        {% for category, pct in category_percentages.items() %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ category }}</span>
          <span class="badge bg-primary rounded-pill">{{ pct }}%</span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-center text-muted">No hay gastos este mes</p>
      {% endif %}
    </div>
  </div>

  <hr class="my-5">

  <div class="card card-custom">
    <div class="card-body text-center">
      <h4 class="mb-4">ü§ñ Asesor Financiero IA</h4>
      <p class="text-muted mb-4">Obt√©n consejos personalizados basados en tus gastos del mes</p>

      <button id="load-ai" class="btn btn-primary btn-custom">
        üîç Analizar con IA
      </button>

      <div id="ai-output" class="alert alert-info mt-4 d-none" style="text-align: left;">
        <strong>üí° Consejo:</strong>
        <p class="mb-0 mt-2" id="ai-message"></p>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('load-ai').addEventListener('click', function () {
    const button = this;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Analizando...';
    button.disabled = true;
    button.classList.add('disabled');

    const outputDiv = document.getElementById('ai-output');
    const messageDiv = document.getElementById('ai-message');
    outputDiv.classList.add('d-none');
    messageDiv.textContent = '';

    fetch('/analysis/ai')
      .then(response => response.json())
      .then(data => {
        messageDiv.textContent = data.message;
        outputDiv.classList.remove('d-none');
        button.innerHTML = '‚úì An√°lisis Completo';

        // Mostrar toast de √©xito
        if (window.Toast) {
          Toast.success('An√°lisis de IA completado');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        messageDiv.textContent = 'Error al cargar la respuesta de la IA. Por favor, intenta de nuevo.';
        outputDiv.classList.remove('d-none');
        outputDiv.classList.remove('alert-info');
        outputDiv.classList.add('alert-danger');
        button.innerHTML = originalText;
        button.disabled = false;
        button.classList.remove('disabled');

        // Mostrar toast de error
        if (window.Toast) {
          Toast.error('No se pudo obtener el an√°lisis de IA');
        }
      });
  });
</script>
{% endblock %}
