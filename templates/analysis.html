{% extends "layout.html" %}

{% block title %}
Monthly Analysis
{% endblock %}

{% block main %}
<div class="container mt-4">
  <h2 class="text-center mb-4">Monthly Analysis</h2>

  <div class="row text-center mb-5">
    <div class="col">
      <p class="fw-bold">Total Income:</p>
      <p class="text-success">${{ "%.2f"|format(income_total|float) }} ({{ income_pct }}%)</p>
    </div>
    <div class="col">
      <p class="fw-bold">Total Expenses:</p>
      <p class="text-danger">${{ "%.2f"|format(expense_total|float) }} ({{ expense_pct }}%)</p>
    </div>
  </div>

  <h5 class="text-center">Spending by Category</h5>
  <ul class="list-group mx-auto" style="max-width: 400px;">
    {% for category, pct in category_percentages.items() %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      {{ category }}
      <span class="badge bg-primary rounded-pill">{{ pct }}%</span>
    </li>
    {% else %}
    <li class="list-group-item text-center text-muted">No expenses this month</li>
    {% endfor %}
  </ul>
</div>

<hr class="my-4">
<h4 class="text-center">ü§ñ GastoPro AI Advisor</h4>

<div class="text-center mb-3">
  <button id="load-ai" class="btn btn-outline-primary">üîç Analizar con IA</button>
</div>

<div id="ai-output" class="alert alert-info mx-auto d-none" style="max-width: 700px;"></div>
<script>
  document.getElementById('load-ai').addEventListener('click', function () {
    const button = this;
    button.textContent = '‚è≥ Cargando...';
    button.disabled = true;
    button.classList.add('disabled');
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-outline-secondary');

    const outputDiv = document.getElementById('ai-output');
    outputDiv.classList.add('d-none');
    outputDiv.textContent = 'Cargando...';

    fetch('/analysis/ai')
      .then(response => response.json())
      .then(data => {
        outputDiv.textContent = data.message;
        outputDiv.classList.remove('d-none');
      })
      .catch(error => {
        console.error('Error:', error);
        outputDiv.textContent = 'Error al cargar la respuesta de la IA.';
        outputDiv.classList.remove('d-none');
      })
      .finally(() => {
        button.disable = true;
        button.textContent = 'üîç Analizado';
      });
  });
</script>
{% endblock %}
